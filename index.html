<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ë≥áÂÆâËàáÊï∏‰ΩçÂπ≥Ê¨ä - Á≤íÂ≠ê‰∫íÂãïÊ∏¨È©ó</title>

    <!-- Meta Tags for GitHub/SEO -->
    <meta name="description" content="‰∫íÂãïÂºèË≥áÂÆâËàáÊï∏‰ΩçÂπ≥Ê¨äÊ∏¨È©óÔºåÁµêÂêà MediaPipe ÊâãÂã¢Ëæ®Ë≠òÊäÄË°ì„ÄÇ">
    <meta property="og:title" content="Ë≥áÂÆâËàáÊï∏‰ΩçÂπ≥Ê¨ä - Á≤íÂ≠ê‰∫íÂãïÊ∏¨È©ó">
    <meta property="og:description" content="‰ΩøÁî®ÊâãÂã¢ÊéßÂà∂ÁöÑÁèæ‰ª£ÂåñÁ∂≤È†ÅÈÅäÊà≤ÔºåÂ≠∏ÁøíË≥áÂÆâÁü•Ë≠ò„ÄÇ">
    <meta property="og:type" content="website">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;500;700&family=Orbitron:wght@500&display=swap"
        rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        :root {
            --primary: #00f2ff;
            --correct: #00ff88;
            --wrong: #ff0055;
            --bg-glass: rgba(10, 20, 30, 0.85);
            --border: rgba(255, 255, 255, 0.2);
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            font-family: 'Noto Sans TC', sans-serif;
            user-select: none;
        }

        canvas {
            display: block;
        }

        #ui-container {
            position: absolute;
            inset: 0;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            z-index: 10;
        }

        /* --- È†ÇÈÉ®ÁãÄÊÖãÂàó --- */
        .status-bar {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
            box-sizing: border-box;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 0 0 10px rgba(0, 242, 255, 0.5);
            position: relative;
        }

        .timer-container {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
            color: var(--primary);
            font-weight: bold;
        }

        .life-container {
            font-size: 1.5rem;
            color: #ff3333;
        }

        .score-container {
            text-align: right;
        }

        .score-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            letter-spacing: 2px;
        }

        .score-value {
            font-size: 2rem;
            color: #fff;
            font-weight: bold;
        }

        .combo-text {
            font-size: 1rem;
            color: #ffcc00;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .combo-text.visible {
            opacity: 1;
        }

        /* --- È°åÁõÆÂçÄ --- */
        #question-box {
            margin-top: 10px;
            background: var(--bg-glass);
            backdrop-filter: blur(12px);
            padding: 30px 50px;
            border-radius: 16px;
            border: 1px solid var(--primary);
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.2);
            text-align: center;
            max-width: 800px;
            width: 90%;
            transform: translateY(-50px);
            opacity: 0;
            transition: all 0.5s;
        }

        #question-box.visible {
            transform: translateY(0);
            opacity: 1;
        }

        #question-text {
            color: #fff;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        /* --- ÈÅ∏È†ÖÂçÄ --- */
        #answers-container {
            margin-top: auto;
            margin-bottom: 50px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            width: 80%;
            max-width: 1000px;
        }

        .answer-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            color: #fff;
            font-size: 1.4rem;
            position: relative;
            transition: all 0.3s;
            overflow: hidden;
        }

        .option-num {
            position: absolute;
            top: 10px;
            left: 15px;
            font-family: 'Orbitron', sans-serif;
            color: rgba(255, 255, 255, 0.3);
            font-size: 1rem;
        }

        .fill-overlay {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 0%;
            background: rgba(0, 242, 255, 0.2);
            z-index: -1;
            transition: width 0.1s linear;
        }

        .answer-card.hovering {
            border-color: var(--primary);
            box-shadow: 0 0 15px var(--primary);
            transform: scale(1.02);
        }

        .answer-card.correct {
            border-color: var(--correct);
            background: rgba(0, 255, 136, 0.2);
            box-shadow: 0 0 30px var(--correct);
        }

        .answer-card.wrong {
            border-color: var(--wrong);
            background: rgba(255, 0, 85, 0.2);
        }

        /* --- Ë¶ñÁ™ó: Ë©≥Ëß£ & ÁµêÁÆó --- */
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: rgba(10, 15, 20, 0.95);
            border: 2px solid var(--border);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 600px;
            width: 90%;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            z-index: 100;
        }

        .modal.visible {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }

        /* Ë©≥Ëß£Â∞àÁî® */
        #feedback-modal.correct-mode {
            border-color: var(--correct);
        }

        #feedback-modal.wrong-mode {
            border-color: var(--wrong);
        }

        /* ÁµêÁÆóÂ∞àÁî® */
        #gameover-modal {
            border-color: var(--primary);
            box-shadow: 0 0 50px rgba(0, 242, 255, 0.3);
        }

        .modal-title {
            font-size: 2rem;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .modal-content {
            font-size: 1.2rem;
            color: #ddd;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        /* ÈáçÁé©ÊåâÈàï (ÊâãÂã¢‰∫íÂãïÁî®) */
        .restart-btn {
            display: inline-block;
            margin-top: 20px;
            padding: 15px 40px;
            border: 2px solid #fff;
            border-radius: 50px;
            font-size: 1.5rem;
            color: #fff;
            position: relative;
            overflow: hidden;
        }

        .restart-btn .fill-overlay {
            background: rgba(255, 255, 255, 0.3);
        }

        /* ÊîùÂΩ±Ê©üÈ†êË¶ΩË¶ñÁ™ó */
        #input-video {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 150px;
            height: 150px;
            object-fit: cover;
            /* Ë£ÅÂàáÊàêÊ≠£ÊñπÂΩ¢ */
            border-radius: 12px;
            border: 2px solid rgba(0, 242, 255, 0.5);
            z-index: 50;
            transform: scaleX(-1);
            /* Èè°ÂÉèÁøªËΩâ */
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        #input-video:hover {
            opacity: 1;
        }

        /* ÂÖ®Ëû¢ÂπïË¶ÜËìãÂ±§Ê®£Âºè */
        .screen-overlay {
            position: fixed;
            inset: 0;
            background: rgba(5, 10, 15, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease, visibility 0.5s;
            backdrop-filter: blur(10px);
        }

        .screen-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .menu-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 4rem;
            margin-bottom: 50px;
            background: linear-gradient(to right, var(--primary), #fff);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
            letter-spacing: 12px;
            text-align: center;
        }

        .menu-btn {
            width: 280px;
            padding: 18px;
            margin: 15px;
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            text-decoration: none;
            text-transform: uppercase;
            letter-spacing: 2px;
            pointer-events: auto;
        }

        .menu-btn:hover {
            background: var(--primary);
            color: #000;
            box-shadow: 0 0 30px var(--primary);
            transform: translateY(-3px);
        }

        .menu-btn.primary {
            background: var(--primary);
            color: #000;
        }

        /* ÂÄíÊï∏Ë®àÊôÇÊ®£Âºè */
        #countdown-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 12rem;
            color: var(--primary);
            text-shadow: 0 0 50px var(--primary);
            animation: countPulse 1s infinite;
        }

        @keyframes countPulse {
            0% {
                transform: scale(0.8);
                opacity: 0.5;
            }

            50% {
                transform: scale(1.1);
                opacity: 1;
            }

            100% {
                transform: scale(1);
                opacity: 0;
            }
        }

        /* Help Ëàá Leaderboard ÈÄ£ÁµêÊ®£Âºè (Â∑¶‰∏ãËßí) */
        .bottom-controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 15px;
            pointer-events: auto;
            z-index: 100;
        }

        .control-btn {
            color: var(--primary);
            text-decoration: none;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            border: 1px solid var(--primary);
            padding: 8px 18px;
            border-radius: 25px;
            transition: all 0.3s;
            background: rgba(10, 20, 30, 0.8);
            backdrop-filter: blur(5px);
            cursor: pointer;
        }

        .control-btn:hover {
            background: var(--primary);
            color: #000;
            box-shadow: 0 0 15px var(--primary);
            transform: translateY(-2px);
        }

        /* ÊéíË°åÊ¶úË°®Ê†ºÊ®£Âºè */
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            color: #fff;
        }

        .leaderboard-table th,
        .leaderboard-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .leaderboard-table th {
            color: var(--primary);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
        }

        .leaderboard-table tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.03);
        }

        .rank-1 {
            color: #ffd700;
            font-weight: bold;
        }

        .rank-2 {
            color: #c0c0c0;
        }

        .rank-3 {
            color: #cd7f32;
        }
    </style>
</head>

<body>

    <!-- ÂïüÂãïÁï´Èù¢ -->
    <div id="landing-screen" class="screen-overlay">
        <h1 class="menu-title">Mission<br>Intelligence</h1>
        <button class="menu-btn primary" onclick="goToCameraRequest()">ÈñãÂßãÈÅäÊà≤</button>
        <a href="help.html" class="menu-btn">ÈÅäÊà≤‰ªãÁ¥π</a>
    </div>

    <!-- Ê¨äÂà©Á¢∫Ë™çÁï´Èù¢ -->
    <div id="camera-screen" class="screen-overlay hidden">
        <h2 class="menu-title" style="font-size: 2rem; letter-spacing: 4px;">Á≥ªÁµ±ÊéàÊ¨ä</h2>
        <p style="color: #aaa; margin-bottom: 30px;">Êú¨ÈÅäÊà≤ÈúÄË¶Å‰ΩøÁî®Á∂≤Ë∑ØÊîùÂΩ±Ê©üÈÄ≤Ë°åÊâãÂã¢Ë≠òÂà•</p>
        <button class="menu-btn primary" onclick="enableCameraFlow()">Êéà‰∫àÊ¨äÈôê‰∏¶ÈñãÂïü</button>
        <button class="menu-btn" onclick="location.reload()">ËøîÂõû‰∏ªÈÅ∏ÂñÆ</button>
    </div>

    <!-- ÂÄíÊï∏Ë®àÊôÇÁï´Èù¢ -->
    <div id="countdown-screen" class="screen-overlay hidden">
        <div id="countdown-text">5</div>
        <p style="color: var(--primary); margin-top: 20px; font-family: 'Orbitron';">GET READY</p>
    </div>

    <div id="ui-container">
        <!-- ÁãÄÊÖãÂàó -->
        <div class="status-bar">
            <div class="life-container">
                LIVES: <span id="life-text">‚ù§‚ù§‚ù§</span>
            </div>
            <div class="timer-container" id="timer-text">03:00</div>
            <div class="score-container">
                <div class="score-label">SCORE</div>
                <div class="score-value" id="score-text">0</div>
                <div class="combo-text" id="combo-text">COMBO x1.2!</div>
            </div>
        </div>

        <div class="bottom-controls">
            <a href="help.html" class="control-btn">HELP</a>
            <div class="control-btn" onclick="showLeaderboard()">LEADERBOARD</div>
        </div>

        <!-- È°åÁõÆ -->
        <div id="question-box">
            <div id="question-text">Loading...</div>
        </div>

        <!-- Á≠îÊ°àÈÅ∏È†Ö -->
        <div id="answers-container">
            <div id="ans-0" class="answer-card" data-idx="0"><span class="option-num">A</span>
                <div class="fill-overlay"></div><span class="text">Option A</span>
            </div>
            <div id="ans-1" class="answer-card" data-idx="1"><span class="option-num">B</span>
                <div class="fill-overlay"></div><span class="text">Option B</span>
            </div>
            <div id="ans-2" class="answer-card" data-idx="2"><span class="option-num">C</span>
                <div class="fill-overlay"></div><span class="text">Option C</span>
            </div>
            <div id="ans-3" class="answer-card" data-idx="3"><span class="option-num">D</span>
                <div class="fill-overlay"></div><span class="text">Option D</span>
            </div>
        </div>
    </div>

    <!-- Ë©≥Ëß£Ë¶ñÁ™ó -->
    <div id="feedback-modal" class="modal">
        <div id="feedback-title" class="modal-title">TITLE</div>
        <div id="feedback-content" class="modal-content">Explanation...</div>
    </div>

    <!-- ÁµêÁÆóË¶ñÁ™ó -->
    <div id="gameover-modal" class="modal">
        <div class="modal-title" style="color:var(--primary)">GAME OVER</div>
        <div class="modal-content">
            <p>ÊúÄÁµÇÂæóÂàÜ</p>
            <div style="font-size: 3rem; color: #fff; font-weight: bold; font-family: 'Orbitron';" id="final-score">0
            </div>
        </div>
        <!-- ÈÄôÊòØÁ¨¨ 5 ÂÄã‰∫íÂãïÁõÆÊ®ô -->
        <div id="restart-btn" class="restart-btn">
            ÈáçÊñ∞ÊåëÊà∞
            <div class="fill-overlay"></div>
        </div>
        <div style="margin-top: 15px; font-size: 0.9rem; color: #aaa;">
            Ë´ãÂ∞çÈè°È†≠ÊØîÂá∫ <span style="color:#fff; font-weight:bold; font-size: 1.2rem;">üñêÔ∏è (5)</span>
        </div>
    </div>

    <!-- ÊéíË°åÊ¶úË¶ñÁ™ó -->
    <div id="leaderboard-modal" class="modal">
        <div class="modal-title" style="color:var(--primary)">TOP 10 AGENTS</div>
        <div id="leaderboard-loading" style="color: var(--primary);">Loading data...</div>
        <table class="leaderboard-table" id="leaderboard-table" style="display: none;">
            <thead>
                <tr>
                    <th>RANK</th>
                    <th>DATE / TIME</th>
                    <th>SCORE</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body"></tbody>
        </table>
        <button class="menu-btn" onclick="closeLeaderboard()"
            style="width: 150px; padding: 10px; margin-top: 20px;">ÈóúÈñâ</button>
    </div>

    <!-- È°ØÁ§∫ÊîùÂΩ±Ê©üÁï´Èù¢ (Âè≥‰∏ãËßí) -->
    <video id="input-video"></video>
    <canvas id="stage"></canvas>

    <script>
        let QUIZ_DATA = [];      // ÂéüÂßãÈ°åÂ∫´
        let SHUFFLED_QUIZ = [];  // Ê¥óÁâåÂæåÁöÑÈ°åÂ∫´

        // --- 1. ÈÅäÊà≤ÁãÄÊÖãÁµêÊßã ---
        const GameState = {
            state: 'loading',       // 'loading', 'playing', 'feedback', 'gameover'
            questionIndex: 0,

            // ÈÅäÊà≤Êï∏ÂÄº
            lives: 3,
            score: 0,
            streak: 0,
            questionStartTime: 0,

            // Ë®àÊôÇÂô®
            timeLeft: 180,         // 3 ÂàÜÈêò = 180 Áßí
            timerInterval: null,

            // ÊéíË°åÊ¶úË®≠ÂÆö (Ë´ãÂú®Ê≠§Â°´ÂÖ•ÊÇ®ÁöÑ GAS URL)
            leaderboardURL: 'https://script.google.com/macros/s/AKfycbw-Fw4aIjgQJ_OGY0CpzTK0mTh1j3bf9atgOKKgYuRqp2iDMdwpnVNJxpsUCrE-Obk/exec',

            // ÊâãÂã¢Ë≠òÂà• (Finger Counting)
            detectedCount: 0,       // ÁõÆÂâçÊØèÂπÄÂÅµÊ∏¨Âà∞ÁöÑÊï∏Èáè
            confirmedCount: 0,      // Á¢∫Ë™çÁ©©ÂÆöÁöÑÊï∏Èáè
            lastCountTime: 0,       // ‰∏äÊ¨°Êï∏ÈáèËÆäÂåñÁöÑÊôÇÈñì
            stableTime: 0,          // ÊåÅÁ∫åÁ©©ÂÆöÁöÑÊôÇÈñì accumulate

            chosenAnswer: -1,       // ÈéñÂÆöÁöÑÁ≠îÊ°à (0~3)
            selectionProgress: 0,   // 0.0 ~ 1.0 (ÈõÜÊ∞£ÈÄ≤Â∫¶)

            // UI Â∫ßÊ®ôÁ∑©Â≠ò (Áî®ÊñºÁ≤íÂ≠êÂê∏Âºï)
            targetRects: [],

            currentOptionMapping: []
        };

        // ... (CONFIG, particles, window.onload ‰øùÊåÅ‰∏çËÆä) ...

        const CONFIG = {
            particleCount: 15000,
            baseSpeed: 0.5,
            color: 'rgba(0, 242, 255, 0.8)',
            // Á®çÂæåÂú®Á≤íÂ≠êÈÇèËºØ‰∏≠‰ΩøÁî®
        };

        let canvas, ctx, width, height;
        // ÁßªÈô§Â∫ßÊ®ôÁõ∏Èóú handX, handY, ÊîπÁî® fingerCount
        let currentFingerCount = 0;
        let isHandDetected = false;

        // ... (particles array init) ...
        const particles = {
            x: new Float32Array(CONFIG.particleCount),
            y: new Float32Array(CONFIG.particleCount),
            vx: new Float32Array(CONFIG.particleCount),
            vy: new Float32Array(CONFIG.particleCount),
            originVx: new Float32Array(CONFIG.particleCount),
            originVy: new Float32Array(CONFIG.particleCount)
        };

        // ... (loadCSV, parseCSV, startGame ‰øùÊåÅ‰∏çËÆä) ...

        // --- 3. ÂàùÂßãÂåñ ---
        window.onload = async function () {
            canvas = document.getElementById('stage');
            ctx = canvas.getContext('2d', { alpha: false });
            resize();
            initParticles();

            await loadCSV();

            window.addEventListener('resize', resize);
            requestAnimationFrame(loop);
        };

        async function loadCSV() {
            try {
                const response = await fetch('questions.csv');
                if (!response.ok) throw new Error("File error");
                const text = await response.text();
                parseCSV(text);
                // ‰∏çÂú®Ê≠§ËôïÂëºÂè´ startGameÔºåÊîπÁî±ÂÄíÊï∏Ë®àÊôÇÁµêÊùüÂæåËß∏Áôº
            } catch (err) {
                console.error(err);
                document.getElementById('question-text').textContent = "È°åÂ∫´ËÆÄÂèñÂ§±Êïó";
            }
        }

        // --- 4. ÊµÅÁ®ãË∑≥ËΩâÈÇèËºØ ---
        function goToCameraRequest() {
            document.getElementById('landing-screen').classList.add('hidden');
            document.getElementById('camera-screen').classList.remove('hidden');
        }

        async function enableCameraFlow() {
            document.getElementById('camera-screen').classList.add('hidden');
            document.getElementById('countdown-screen').classList.remove('hidden');

            // ÂàùÂßãÂåñ MediaPipe ÊâãÂã¢Ë≠òÂà•
            try {
                initMediaPipe();
                startCountdown();
            } catch (err) {
                console.error(err);
                alert("ÁÑ°Ê≥ïÂ≠òÂèñÊîùÂΩ±Ê©üÔºåË´ãÊ™¢Êü•Ê¨äÈôêË®≠ÂÆöËàáÁ∂≤È†ÅÂçîÂÆö (ÂøÖÈ†à‰ΩøÁî® HTTPS Êàñ localhost)„ÄÇ");
                location.reload();
            }
        }

        function startCountdown() {
            let count = 5;
            const el = document.getElementById('countdown-text');
            const timer = setInterval(() => {
                count--;
                if (count <= 0) {
                    clearInterval(timer);
                    document.getElementById('countdown-screen').classList.add('hidden');
                    startGame();
                } else {
                    el.textContent = count;
                }
            }, 1000);
        }

        function parseCSV(text) {
            const lines = text.trim().split(/\r?\n/);
            QUIZ_DATA = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const parts = [];
                let current = '', inQuote = false;
                for (let char of line) {
                    if (char === '"') inQuote = !inQuote;
                    else if (char === ',' && !inQuote) { parts.push(current); current = ''; }
                    else current += char;
                }
                parts.push(current);
                const clean = parts.map(p => p.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
                if (clean.length >= 7) {
                    QUIZ_DATA.push({
                        question: clean[0],
                        options: [clean[1], clean[2], clean[3], clean[4]],
                        answer: parseInt(clean[5]) - 1,
                        explanation: clean[6]
                    });
                }
            }
        }

        function initParticles() {
            for (let i = 0; i < CONFIG.particleCount; i++) {
                particles.x[i] = Math.random() * width;
                particles.y[i] = Math.random() * height;
                const a = Math.random() * Math.PI * 2;
                const s = Math.random() * 0.5 + 0.2;
                particles.originVx[i] = Math.cos(a) * s;
                particles.originVy[i] = Math.sin(a) * s;
                particles.vx[i] = particles.originVx[i];
                particles.vy[i] = particles.originVy[i];
            }
        }

        // --- 4. ÈÅäÊà≤ÊµÅÁ®ãÊéßÂà∂ ---

        function startGame() {
            // ÈáçÁΩÆÁãÄÊÖã
            GameState.score = 0;
            GameState.lives = 3;
            GameState.streak = 0;
            GameState.questionIndex = 0;
            GameState.timeLeft = 180; // 3ÂàÜÈêò

            // ÂïüÂãïË®àÊôÇÂô®
            if (GameState.timerInterval) clearInterval(GameState.timerInterval);
            GameState.timerInterval = setInterval(() => {
                if (GameState.state === 'playing' || GameState.state === 'feedback') {
                    GameState.timeLeft--;
                    updateTimerUI();
                    if (GameState.timeLeft <= 0) {
                        endGame('win'); //  Surviving 3 minutes is a win according to user
                    }
                }
            }, 1000);

            // Èö®Ê©üÊâì‰∫ÇÈ°åÂ∫´È†ÜÂ∫è (Shuffle)
            SHUFFLED_QUIZ = [...QUIZ_DATA].sort(() => Math.random() - 0.5);

            updateUI();
            updateTimerUI();

            document.getElementById('gameover-modal').classList.remove('visible');
            loadQuestion(0);
        }

        function updateTimerUI() {
            const m = Math.floor(GameState.timeLeft / 60);
            const s = GameState.timeLeft % 60;
            document.getElementById('timer-text').textContent =
                `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;

            if (GameState.timeLeft < 30) {
                document.getElementById('timer-text').style.color = '#ff3333';
            } else {
                document.getElementById('timer-text').style.color = 'var(--primary)';
            }
        }

        function loadQuestion(idx) {
            if (idx >= SHUFFLED_QUIZ.length) {
                // È°åÁõÆÂÖ®ÂÅöÂÆå‰∫Ü -> ÈÅäÊà≤ÁµêÊùü
                endGame();
                return;
            }

            GameState.state = 'playing';
            GameState.questionIndex = idx;
            GameState.questionStartTime = Date.now();
            GameState.selectionProgress = 0;
            GameState.confirmedCount = 0;
            GameState.chosenAnswer = -1;

            const q = SHUFFLED_QUIZ[idx];

            // Èö®Ê©üÊéíÂàóÈÅ∏È†Ö (Option Shuffle)
            // Âª∫Á´ã‰∏ÄÂÄãÁ¥¢ÂºïÈô£Âàó [0, 1, 2, 3] ‰∏¶Êâì‰∫Ç
            const indices = [0, 1, 2, 3].sort(() => Math.random() - 0.5);
            GameState.currentOptionMapping = indices;

            // UI Êõ¥Êñ∞
            const box = document.getElementById('question-box');
            box.classList.remove('visible');

            // ÈáçÁΩÆÈÅ∏È†ÖÂç°Ê®£Âºè
            for (let i = 0; i < 4; i++) {
                const el = document.getElementById('ans-' + i);
                el.className = 'answer-card';
                el.querySelector('.fill-overlay').style.width = '0%';

                // Ê†πÊìöÊâì‰∫ÇÂæåÁöÑÁ¥¢ÂºïÂ°´ÂÖ•ÊñáÂ≠ó
                // UI ÁöÑ i Â∞çÊáâÂà∞ Ë≥áÊñôÁöÑ indices[i]
                el.querySelector('.text').textContent = q.options[indices[i]];
            }

            setTimeout(() => {
                document.getElementById('question-text').textContent = q.question;
                box.classList.add('visible');
                updateInteractRects();
            }, 500);
        }

        function checkAnswer(uiIndex) {
            GameState.state = 'feedback';
            const q = SHUFFLED_QUIZ[GameState.questionIndex];

            // ÈÄèÈÅé Mapping Â∞çÁÖßÂõûÂéüÂßãÁ≠îÊ°àÁ¥¢Âºï
            // UI ÈÅ∏‰∫Ü uiIndexÔºå‰ª£Ë°®ÂéüÂßãË≥áÊñôÁöÑ indices[uiIndex]
            const originalIndex = GameState.currentOptionMapping[uiIndex];
            const isCorrect = (originalIndex === q.answer);

            const selectedEl = document.getElementById('ans-' + uiIndex);

            if (isCorrect) {
                // --- Á≠îÂ∞ç ---
                selectedEl.classList.add('correct');

                // Ë®àÁÆóÂàÜÊï∏
                const timeSpent = (Date.now() - GameState.questionStartTime) / 1000;
                let timeBonus = 0;
                if (timeSpent < 5) timeBonus = 500;
                else if (timeSpent < 10) timeBonus = 200;

                GameState.streak++;
                let streakMult = 1.0 + (GameState.streak * 0.1); // x1.2, x1.3...

                const points = Math.floor((1000 + timeBonus) * streakMult);
                GameState.score += points;

                updateUI();
                playFeedback(true, "Á≠îÂ∞ç‰∫ÜÔºÅ", `+${points} ÂàÜ`);

                setTimeout(() => {
                    closeFeedback();
                    loadQuestion(GameState.questionIndex + 1);
                }, 2000);

            } else {
                // --- Á≠îÈåØ ---
                selectedEl.classList.add('wrong');

                // ÊâæÂá∫Ê≠£Á¢∫ÈÅ∏È†Ö‰∏¶Ê®ôÁ§∫
                // Â∞ãÊâæ mapping ‰∏≠Âì™ÂÄã UI index Â∞çÊáâÂà∞ q.answer
                const correctUIIndex = GameState.currentOptionMapping.indexOf(q.answer);
                document.getElementById('ans-' + correctUIIndex).classList.add('correct');

                GameState.lives--;
                GameState.streak = 0;
                updateUI();

                playFeedback(false, "Á≠îÈåØ‰∫ÜÔºÅ", q.explanation);

                const nextDelay = 5000;
                setTimeout(() => {
                    closeFeedback();
                    if (GameState.lives <= 0) {
                        endGame();
                    } else {
                        loadQuestion(GameState.questionIndex + 1);
                    }
                }, nextDelay);
            }
        }

        function endGame(reason = 'loss') {
            GameState.state = 'gameover';
            if (GameState.timerInterval) clearInterval(GameState.timerInterval);

            const modal = document.getElementById('gameover-modal');
            const titleEl = modal.querySelector('.modal-title');

            if (reason === 'win') {
                titleEl.textContent = "‰ªªÂãôÊàêÂäü";
                titleEl.style.color = "var(--correct)";
            } else {
                titleEl.textContent = "‰ªªÂãôÂ§±Êïó";
                titleEl.style.color = "var(--wrong)";
            }

            document.getElementById('final-score').textContent = GameState.score;
            modal.classList.add('visible');
            updateInteractRects(); // Á¢∫‰øùÈáçÊñ∞ÊäìÂèñ„ÄåÈáçÁé©ÊåâÈàï„ÄçÁöÑÂ∫ßÊ®ô

            // Ëá™Âãï‰∏äÂÇ≥ÂàÜÊï∏
            submitScore(GameState.score);
        }

        // --- ÊéíË°åÊ¶úÈÇèËºØ ---
        async function submitScore(score) {
            if (!GameState.leaderboardURL) return;
            const now = new Date();
            const dateStr = `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

            try {
                // ‰ΩøÁî® text/plain ÂÇ≥ÈÄÅ JSON ÈÅøÂÖç CORS preflight (GAS ‰∏çÊîØÊè¥ OPTIONS)
                await fetch(GameState.leaderboardURL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ date: dateStr, score: score })
                });
                console.log("Score submitted via text/plain to GAS");
            } catch (err) {
                console.error("Submit error:", err);
            }
        }

        async function showLeaderboard() {
            const modal = document.getElementById('leaderboard-modal');
            const loading = document.getElementById('leaderboard-loading');
            const table = document.getElementById('leaderboard-table');
            const tbody = document.getElementById('leaderboard-body');

            modal.classList.add('visible');
            loading.style.display = 'block';
            table.style.display = 'none';
            tbody.innerHTML = '';

            if (!GameState.leaderboardURL) {
                loading.textContent = "Ë´ãÂÖàË®≠ÂÆö GAS_API_URL";
                return;
            }

            try {
                const response = await fetch(GameState.leaderboardURL);
                const data = await response.json();

                loading.style.display = 'none';
                table.style.display = 'table';

                data.forEach((entry, index) => {
                    const row = document.createElement('tr');
                    const rankClass = index < 3 ? `rank-${index + 1}` : '';
                    row.innerHTML = `
                        <td class="${rankClass}">${index + 1}</td>
                        <td>${entry.time}</td>
                        <td style="font-family: 'Orbitron';">${entry.score.toLocaleString()}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (err) {
                loading.textContent = "ÁÑ°Ê≥ïËÆÄÂèñÊéíË°åË≥áÊñô";
                console.error(err);
            }
        }

        function closeLeaderboard() {
            document.getElementById('leaderboard-modal').classList.remove('visible');
        }

        function updateUI() {
            // ÁîüÂëΩÂÄº (Hearts)
            let hearts = "";
            for (let i = 0; i < GameState.lives; i++) hearts += "‚ù§";
            document.getElementById('life-text').textContent = hearts;

            // ÂàÜÊï∏
            document.getElementById('score-text').textContent = GameState.score;

            // Combo
            const comboEl = document.getElementById('combo-text');
            if (GameState.streak > 1) {
                comboEl.textContent = `COMBO x${(1.0 + GameState.streak * 0.1).toFixed(1)}!`;
                comboEl.classList.add('visible');
            } else {
                comboEl.classList.remove('visible');
            }
        }

        function playFeedback(isCorrect, title, content) {
            const modal = document.getElementById('feedback-modal');
            const tEl = document.getElementById('feedback-title');
            const cEl = document.getElementById('feedback-content');

            modal.className = 'modal visible ' + (isCorrect ? 'correct-mode' : 'wrong-mode');
            tEl.textContent = title;
            tEl.style.color = isCorrect ? 'var(--correct)' : 'var(--wrong)';
            cEl.textContent = content;
        }

        function closeFeedback() {
            document.getElementById('feedback-modal').className = 'modal';
        }

        // --- 5. ‰∫íÂãïËàáËø¥Âúà ---

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            updateInteractRects();
        }

        function updateInteractRects() {
            GameState.targetRects = [];
            for (let i = 0; i < 4; i++) {
                const el = document.getElementById('ans-' + i);
                if (el && el.offsetParent !== null) {
                    GameState.targetRects.push(el.getBoundingClientRect());
                } else {
                    GameState.targetRects.push(null);
                }
            }
        }

        // --- 5. ‰∏ªÂæ™Áí∞ (ÈáçÂØ´ÈÇèËºØ) ---

        // --- 5. ‰∏ªÂæ™Áí∞ (Finger Counting Logic) ---

        function loop() {
            // Âπ≥ÊªëÊâãÊåáË®àÊï∏ÈÇèËºØ
            if (currentFingerCount !== GameState.detectedCount) {
                GameState.detectedCount = currentFingerCount;
                GameState.lastCountTime = Date.now();
            }

            const stableDuration = Date.now() - GameState.lastCountTime;

            // ÁãÄÊÖãÊ©ü: Á≠îÈ°å‰∏≠
            if (GameState.state === 'playing') {
                // ÂøÖÈ†àÁ©©ÂÆö 300ms ÊâçÁÆóÁ¢∫Ë™çË©≤ÊâãÂã¢ (Èò≤ÈñÉÁàç)
                // 1~4 Ê†πÊâãÊåáÂ∞çÊáâ 0~3 (A~D)
                if (stableDuration > 300 && GameState.detectedCount >= 1 && GameState.detectedCount <= 4) {
                    const targetIndex = GameState.detectedCount - 1;

                    if (GameState.chosenAnswer !== targetIndex) {
                        // ÊèõÁ≠îÊ°à‰∫ÜÔºåÈáçÁΩÆÈÄ≤Â∫¶
                        GameState.chosenAnswer = targetIndex;
                        GameState.selectionProgress = 0;
                        document.querySelectorAll('.answer-card').forEach(el => el.classList.remove('hovering'));
                        document.querySelectorAll('.fill-overlay').forEach(el => el.style.width = '0%');
                    } else {
                        // Âêå‰∏ÄÂÄãÁ≠îÊ°àÔºåÂ¢ûÂä†ÈõÜÊ∞£ÈÄ≤Â∫¶
                        GameState.selectionProgress += 0.03; // Á¥Ñ 0.5~1ÁßíÈõÜÊªø

                        // Visual Update
                        const el = document.getElementById('ans-' + targetIndex);
                        if (el) {
                            el.classList.add('hovering');
                            el.querySelector('.fill-overlay').style.width = Math.min(GameState.selectionProgress * 100, 100) + '%';
                        }

                        if (GameState.selectionProgress >= 1.0) {
                            checkAnswer(targetIndex);
                            // Ëß∏ÁôºÂæåÈáçÁΩÆ‰ª•Èò≤ÈÄ£Á∫åËß∏Áôº
                            GameState.chosenAnswer = -1;
                            GameState.selectionProgress = 0;
                        }
                    }
                } else {
                    // ÊâãÊåáÊîæÈñã or 0 Ê†π or ‰∏çÁ©©ÂÆö -> ÊÖ¢ÊÖ¢Â∞áÈÄ≤Â∫¶Ê≠∏Èõ∂
                    if (GameState.selectionProgress > 0) {
                        GameState.selectionProgress -= 0.05;
                        if (GameState.selectionProgress <= 0) {
                            GameState.selectionProgress = 0;
                            GameState.chosenAnswer = -1;
                            document.querySelectorAll('.answer-card').forEach(el => el.classList.remove('hovering'));
                            document.querySelectorAll('.fill-overlay').forEach(el => el.style.width = '0%');
                        } else {
                            // Ë¶ñË¶∫Ê∂àÈÄÄ
                            if (GameState.chosenAnswer !== -1) {
                                document.querySelector(`#ans-${GameState.chosenAnswer} .fill-overlay`).style.width = (GameState.selectionProgress * 100) + '%';
                            }
                        }
                    }
                }
            }
            // ÁãÄÊÖãÊ©ü: Game Over
            else if (GameState.state === 'gameover') {
                // ÂÅµÊ∏¨„Äå5„Äç(ÊâãÊéå) ‰æÜÈáçÁé©
                if (stableDuration > 500 && currentFingerCount === 5) {
                    GameState.selectionProgress += 0.02;
                    const btn = document.getElementById('restart-btn');
                    if (btn) btn.querySelector('.fill-overlay').style.width = Math.min(GameState.selectionProgress * 100, 100) + '%';

                    if (GameState.selectionProgress >= 1.0) {
                        startGame();
                    }
                } else {
                    GameState.selectionProgress = 0;
                    const btn = document.getElementById('restart-btn');
                    if (btn) btn.querySelector('.fill-overlay').style.width = '0%';
                }
            }

            updateParticles();
            draw();
            requestAnimationFrame(loop);
        }

        function updateParticles() {
            let tx = -1000, ty = -1000;
            let forceMult = 0;

            if (GameState.state === 'playing' && GameState.chosenAnswer !== -1) {
                const r = GameState.targetRects[GameState.chosenAnswer];
                if (r) {
                    tx = r.left + r.width / 2;
                    ty = r.top + r.height / 2;
                    forceMult = 5.0; // Âº∑ÂäõÂê∏ÂºïÂà∞Âç°Áâá
                }
            } else if (GameState.state === 'gameover' && GameState.selectionProgress > 0) {
                const btn = document.getElementById('restart-btn');
                if (btn) {
                    const r = btn.getBoundingClientRect();
                    tx = r.left + r.width / 2;
                    ty = r.top + r.height / 2;
                    forceMult = 5.0;
                }
            }

            for (let i = 0; i < CONFIG.particleCount; i++) {
                let pvx = particles.vx[i], pvy = particles.vy[i];
                let px = particles.x[i], py = particles.y[i];

                if (forceMult > 0 && isHandDetected) {
                    const dx = tx - px, dy = ty - py;
                    const dSq = dx * dx + dy * dy;
                    if (dSq < CONFIG.interactionRadiusSq * 2 && dSq > 100) {
                        const f = (1 - dSq / (CONFIG.interactionRadiusSq * 2)) * 0.002 * forceMult;
                        pvx += dx * f;
                        pvy += dy * f;
                    }
                }

                pvx *= 0.95; pvy *= 0.95;
                pvx += particles.originVx[i] * 0.05; pvy += particles.originVy[i] * 0.05;

                particles.x[i] += pvx; particles.y[i] += pvy;
                if (particles.x[i] < 0) particles.x[i] = width; else if (particles.x[i] > width) particles.x[i] = 0;
                if (particles.y[i] < 0) particles.y[i] = height; else if (particles.y[i] > height) particles.y[i] = 0;

                particles.vx[i] = pvx; particles.vy[i] = pvy;
            }
        }

        function draw() {
            ctx.fillStyle = 'rgba(5, 5, 10, 0.3)';
            ctx.fillRect(0, 0, width, height);

            ctx.fillStyle = CONFIG.color;
            if (GameState.chosenAnswer !== -1) ctx.fillStyle = '#00ffcc';

            for (let i = 0; i < CONFIG.particleCount; i++) {
                ctx.fillRect(~~particles.x[i], ~~particles.y[i], 1, 1);
            }

            // ‰∏≠Â§ÆÈ°ØÁ§∫Áï∂ÂâçÊâãÂã¢ÊèêÁ§∫
            if (isHandDetected && GameState.state === 'playing') {
                ctx.font = "bold 80px Orbitron";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillStyle = "rgba(255, 255, 255, 0.2)";

                let text = "";
                if (currentFingerCount === 1) text = "A";
                else if (currentFingerCount === 2) text = "B";
                else if (currentFingerCount === 3) text = "C";
                else if (currentFingerCount === 4) text = "D";

                if (text) {
                    // È°ØÁ§∫ÊñáÂ≠ó
                    ctx.fillText(text, width / 2, height / 2);

                    // Áï´ÂÄãÂ§ñÂúà
                    ctx.beginPath();
                    ctx.arc(width / 2, height / 2, 60, 0, Math.PI * 2);
                    ctx.strokeStyle = "rgba(0, 242, 255, 0.3)";
                    ctx.lineWidth = 5;
                    ctx.stroke();

                    // Áï´ÈÄ≤Â∫¶Âúà (Progress Ring)
                    if (GameState.selectionProgress > 0) {
                        const startAngle = -Math.PI / 2;
                        const endAngle = startAngle + (Math.PI * 2 * GameState.selectionProgress);
                        ctx.beginPath();
                        ctx.arc(width / 2, height / 2, 60, startAngle, endAngle);
                        ctx.strokeStyle = "#00f2ff";
                        ctx.lineWidth = 8;
                        ctx.stroke();
                    }
                }
            }
        }

        // --- 6. MediaPipe ---
        function initMediaPipe() {
            const v = document.getElementById('input-video');
            const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
            hands.setOptions({ maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });
            hands.onResults(onHandsResults);
            new Camera(v, { onFrame: async () => await hands.send({ image: v }), width: 640, height: 480 }).start();
        }

        function onHandsResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                isHandDetected = true;
                const landmarks = results.multiHandLandmarks[0];
                currentFingerCount = countFingers(landmarks);
            } else {
                isHandDetected = false;
                currentFingerCount = 0;
            }
        }

        function countFingers(lm) {
            let count = 0;
            // ÊãáÊåá (Thumb) Âà§ÂÆö - Ê™¢Êü• 4 ÊòØÂê¶Âú® 3 ÁöÑÂ∑¶ÈÇä/Âè≥ÈÇä (ÂèñÊ±∫ÊñºÊâãËÉåÈÇÑÊòØÊâãÊéå)
            // ÊØîËºÉÁ©©ÂÅ•ÁöÑÊñπÂºèÔºöÊ™¢Êü•ÊãáÊåáÂ∞ñ(4) Ëàá Â∞èÊåáÊ†πÈÉ®(17) ÁöÑË∑ùÈõ¢ ÊòØÂê¶Â§ßÊñº È£üÊåáÊ†πÈÉ®(5) Ëàá Â∞èÊåáÊ†πÈÉ®(17) ÁöÑË∑ùÈõ¢
            const distThumb = Math.hypot(lm[4].x - lm[17].x, lm[4].y - lm[17].y);
            const distIndexBase = Math.hypot(lm[5].x - lm[17].x, lm[5].y - lm[17].y);

            if (distThumb > distIndexBase * 1.1) count++;

            // È£üÊåá: 8 < 6 (Y Ëª∏Âêë‰∏äÁÇ∫Â∞è)
            if (lm[8].y < lm[6].y) count++;
            // ‰∏≠Êåá: 12 < 10
            if (lm[12].y < lm[10].y) count++;
            // ÁÑ°ÂêçÊåá: 16 < 14
            if (lm[16].y < lm[14].y) count++;
            // Â∞èÊåá: 20 < 18
            if (lm[20].y < lm[18].y) count++;

            return count;
        }


    </script>
</body>

</html>